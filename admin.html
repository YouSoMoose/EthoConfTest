<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Ethos Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #0e0e11;
  --s1: #17171c;
  --s2: #1f1f27;
  --s3: #27272f;
  --border: #2e2e3a;
  --accent: #FCBD9D;
  --accent-dim: rgba(252,189,157,0.15);
  --accent-border: rgba(252,189,157,0.3);
  --green: #52d68a;
  --red: #f07070;
  --blue: #6aabf7;
  --purple: #b987f5;
  --yellow: #f5c842;
  --text: #eeece8;
  --sub: #9999aa;
  --muted: #5a5a6a;
  --r: 14px;
  --font-head: 'Syne', sans-serif;
  --font-body: 'DM Sans', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body);overflow-x:hidden}
body{min-height:100dvh}

/* ‚îÄ‚îÄ‚îÄ TRANSITIONS ‚îÄ‚îÄ‚îÄ */
.page{display:none;min-height:100dvh;flex-direction:column;animation:fadeUp .25s ease}
.page.active{display:flex}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
#pg-login{background:radial-gradient(ellipse at 70% -10%, #281800 0%, var(--bg) 55%);align-items:center;justify-content:center;padding:24px}
.login-wrap{width:100%;max-width:360px}
.logo-mark{display:flex;align-items:center;gap:10px;margin-bottom:32px}
.logo-sq{width:42px;height:42px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:800;font-size:20px;color:#111}
.logo-text{font-family:var(--font-head);font-weight:800;font-size:20px}
.logo-text span{color:var(--accent)}
.login-heading{font-family:var(--font-head);font-weight:800;font-size:32px;line-height:1.1;margin-bottom:8px}
.login-sub{color:var(--sub);font-size:14px;margin-bottom:36px;line-height:1.5}
.btn-google{width:100%;background:#fff;color:#1a1a1a;border:none;border-radius:12px;padding:15px 20px;font-size:15px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all .2s;font-family:var(--font-body);margin-bottom:24px}
.btn-google:hover{background:#f0ede8;transform:translateY(-1px);box-shadow:0 8px 24px rgba(252,189,157,0.2)}
.divider{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.divider span{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.dev-section-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.dev-pills{display:flex;flex-wrap:wrap;gap:8px}
.dev-pill{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:7px 13px;font-size:12px;cursor:pointer;color:var(--sub);transition:all .15s;font-family:var(--font-head);font-weight:600}
.dev-pill:hover,.dev-pill:active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar{background:var(--s1);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:200;min-height:56px}
.topbar-back{background:none;border:none;color:var(--sub);cursor:pointer;padding:4px 6px;border-radius:8px;display:flex;align-items:center;font-size:18px;transition:all .15s}
.topbar-back:hover{background:var(--s3);color:var(--text)}
.topbar-title{font-family:var(--font-head);font-weight:700;font-size:16px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topbar-actions{display:flex;gap:8px;align-items:center}
.role-chip{font-size:10px;font-family:var(--font-head);font-weight:700;letter-spacing:.06em;padding:3px 8px;border-radius:6px;text-transform:uppercase;white-space:nowrap}
.chip-super{background:rgba(185,135,245,0.15);color:var(--purple);border:1px solid rgba(185,135,245,0.3)}
.chip-tech{background:rgba(106,171,247,0.15);color:var(--blue);border:1px solid rgba(106,171,247,0.3)}
.chip-entity{background:rgba(252,189,157,0.15);color:var(--accent);border:1px solid var(--accent-border)}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;font-family:var(--font-head);cursor:pointer;flex-shrink:0;background:var(--accent);color:#111;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}

/* ‚îÄ‚îÄ‚îÄ SCROLL CONTENT ‚îÄ‚îÄ‚îÄ */
.content{flex:1;overflow-y:auto;padding:16px 16px 120px}

/* ‚îÄ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ‚îÄ */
.sec{font-size:10px;font-family:var(--font-head);font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;margin-top:4px}

/* ‚îÄ‚îÄ‚îÄ STAT GRID ‚îÄ‚îÄ‚îÄ */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px}
.stat.hi{background:linear-gradient(135deg,rgba(252,189,157,.12),rgba(252,189,157,.04));border-color:var(--accent-border)}
.stat-n{font-family:var(--font-head);font-weight:800;font-size:30px;line-height:1;margin-bottom:4px}
.stat-l{font-size:11px;color:var(--sub)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:5px;animation:blink 1.8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ‚îÄ LIST TILES ‚îÄ‚îÄ‚îÄ */
.tiles{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.tile{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .18s}
.tile:active{transform:scale(.98);background:var(--s2)}
.tile-ico{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
.ico-o{background:rgba(252,189,157,.13)}
.ico-b{background:rgba(106,171,247,.13)}
.ico-g{background:rgba(82,214,138,.13)}
.ico-p{background:rgba(185,135,245,.13)}
.ico-r{background:rgba(240,112,112,.13)}
.ico-y{background:rgba(245,200,66,.13)}
.tile-body{flex:1;min-width:0}
.tile-name{font-family:var(--font-head);font-weight:700;font-size:14px}
.tile-desc{font-size:12px;color:var(--sub);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tile-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.badge{background:var(--accent);color:#111;font-size:10px;font-weight:700;font-family:var(--font-head);border-radius:7px;padding:2px 7px}
.badge-red{background:var(--red);color:#fff}
.badge-blue{background:var(--blue);color:#111}
.chevron{color:var(--muted);font-size:16px}

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--s1);border-top:1px solid var(--border);display:flex;padding:6px 0 max(10px,env(safe-area-inset-bottom));z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;padding:6px 4px;color:var(--muted);transition:color .2s;font-family:var(--font-body)}
.nav-btn.active{color:var(--accent)}
.nav-btn svg{width:20px;height:20px;stroke-width:2}
.nav-btn span{font-size:10px;font-weight:500}
.nav-pip{width:4px;height:4px;border-radius:50%;background:var(--red);position:absolute;top:-2px;right:-2px}
.nav-ico-wrap{position:relative;display:inline-flex}

/* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
.form-group{margin-bottom:16px}
.form-label{font-size:12px;color:var(--sub);font-weight:500;margin-bottom:6px;display:block}
.form-input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-size:14px;font-family:var(--font-body);transition:border-color .2s;outline:none}
.form-input:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--muted)}
textarea.form-input{resize:vertical;min-height:90px}
.form-input select{background:var(--s2)}
select.form-input{appearance:none;cursor:pointer}
.btn{width:100%;padding:14px;border:none;border-radius:11px;font-size:15px;font-weight:600;font-family:var(--font-head);cursor:pointer;transition:all .2s}
.btn-accent{background:var(--accent);color:#111}
.btn-accent:hover{background:#fdd0b5;transform:translateY(-1px)}
.btn-ghost{background:var(--s2);border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{background:var(--s3)}
.btn-danger{background:rgba(240,112,112,.15);border:1px solid rgba(240,112,112,.3);color:var(--red)}
.btn-sm{width:auto;padding:8px 16px;font-size:13px}

/* ‚îÄ‚îÄ‚îÄ CARDS (messages) ‚îÄ‚îÄ‚îÄ */
.msg-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.msg-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px;cursor:pointer;transition:all .18s}
.msg-card.unread{border-color:var(--accent-border);background:rgba(252,189,157,.05)}
.msg-card:active{transform:scale(.99)}
.msg-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px}
.msg-from{font-family:var(--font-head);font-weight:700;font-size:14px}
.msg-time{font-size:11px;color:var(--muted);white-space:nowrap}
.msg-preview{font-size:13px;color:var(--sub);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.msg-tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.tag{font-size:10px;padding:2px 7px;border-radius:5px;font-family:var(--font-head);font-weight:600}
.tag-new{background:rgba(252,189,157,.15);color:var(--accent);border:1px solid var(--accent-border)}
.tag-read{background:var(--s3);color:var(--muted)}
.tag-replied{background:rgba(82,214,138,.15);color:var(--green);border:1px solid rgba(82,214,138,.3)}

/* ‚îÄ‚îÄ‚îÄ CHAT THREAD ‚îÄ‚îÄ‚îÄ */
.thread-msgs{display:flex;flex-direction:column;gap:12px;padding:16px 16px 0}
.bubble-wrap{display:flex;flex-direction:column;gap:2px}
.bubble-wrap.from-user{align-items:flex-start}
.bubble-wrap.from-admin{align-items:flex-end}
.bubble{max-width:78%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.5}
.bubble-wrap.from-user .bubble{background:var(--s2);border:1px solid var(--border);border-bottom-left-radius:4px}
.bubble-wrap.from-admin .bubble{background:var(--accent);color:#111;border-bottom-right-radius:4px}
.bubble-name{font-size:11px;color:var(--muted);margin-bottom:3px;font-weight:500}
.bubble-time{font-size:10px;color:var(--muted);margin-top:3px}
.reply-bar{padding:12px 16px;background:var(--s1);border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;position:sticky;bottom:0}
.reply-input{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:10px 16px;color:var(--text);font-size:14px;font-family:var(--font-body);outline:none;resize:none;max-height:100px;line-height:1.4}
.reply-input:focus{border-color:var(--accent)}
.send-btn{width:40px;height:40px;border-radius:50%;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.send-btn:hover{background:#fdd0b5}
.send-btn:active{transform:scale(.92)}

/* ‚îÄ‚îÄ‚îÄ RATING DISPLAY ‚îÄ‚îÄ‚îÄ */
.vote-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:10px}
.vote-company{font-family:var(--font-head);font-weight:700;font-size:16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.vote-total{font-size:12px;color:var(--sub)}
.score-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.score-label{font-size:12px;color:var(--sub);width:100px;flex-shrink:0}
.score-bar-wrap{flex:1;background:var(--s3);border-radius:100px;height:8px;overflow:hidden}
.score-bar{height:100%;border-radius:100px;background:var(--accent);transition:width .6s ease}
.score-num{font-family:var(--font-head);font-weight:700;font-size:13px;width:28px;text-align:right;flex-shrink:0}

/* ‚îÄ‚îÄ‚îÄ ENTITY TILE EDITOR ‚îÄ‚îÄ‚îÄ */
.tile-preview{background:var(--s2);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:20px;display:flex;gap:14px;align-items:flex-start}
.tile-preview-logo{width:52px;height:52px;border-radius:12px;background:var(--s3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden}
.tile-preview-logo img{width:100%;height:100%;object-fit:cover}
.tile-preview-body{flex:1;min-width:0}
.tile-preview-name{font-family:var(--font-head);font-weight:700;font-size:15px;margin-bottom:4px}
.tile-preview-tag{font-size:12px;color:var(--sub);margin-bottom:6px}

/* ‚îÄ‚îÄ‚îÄ USER MANAGEMENT ‚îÄ‚îÄ‚îÄ */
.user-row{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.user-ava{width:38px;height:38px;border-radius:50%;background:var(--s3);display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-weight:700;font-size:14px;flex-shrink:0}
.user-info{flex:1;min-width:0}
.user-name{font-family:var(--font-head);font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-size:11px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-role-sel{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 8px;color:var(--text);font-size:12px;font-family:var(--font-head);font-weight:600;cursor:pointer;outline:none}
.user-role-sel:focus{border-color:var(--accent)}

/* ‚îÄ‚îÄ‚îÄ MODERATION ‚îÄ‚îÄ‚îÄ */
.mod-card{background:var(--s1);border:1px solid rgba(240,112,112,.3);border-radius:var(--r);padding:14px;margin-bottom:8px}
.mod-content{background:var(--s2);border-radius:8px;padding:10px;font-size:13px;color:var(--sub);margin:8px 0;font-style:italic}
.mod-actions{display:flex;gap:8px;margin-top:10px}
.mod-btn{flex:1;padding:9px;border-radius:9px;font-size:12px;font-family:var(--font-head);font-weight:700;border:none;cursor:pointer;transition:all .15s}
.mod-approve{background:rgba(82,214,138,.15);color:var(--green);border:1px solid rgba(82,214,138,.3)}
.mod-reject{background:rgba(240,112,112,.15);color:var(--red);border:1px solid rgba(240,112,112,.3)}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:24px 20px max(24px,env(safe-area-inset-bottom));width:100%;max-width:500px;transform:translateY(40px);transition:transform .3s ease;max-height:80dvh;overflow-y:auto}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 20px}
.modal-title{font-family:var(--font-head);font-weight:800;font-size:18px;margin-bottom:4px}
.modal-sub{font-size:13px;color:var(--sub);margin-bottom:20px}

/* ‚îÄ‚îÄ‚îÄ BROADCAST ‚îÄ‚îÄ‚îÄ */
.broadcast-bar{background:rgba(252,189,157,.1);border:1px solid var(--accent-border);border-radius:var(--r);padding:14px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.broadcast-ico{font-size:20px}
.broadcast-text{flex:1}
.broadcast-label{font-family:var(--font-head);font-weight:700;font-size:14px;color:var(--accent)}
.broadcast-sub{font-size:11px;color:var(--sub);margin-top:2px}
.broadcast-btn{background:var(--accent);color:#111;border:none;border-radius:8px;padding:8px 14px;font-size:12px;font-family:var(--font-head);font-weight:700;cursor:pointer;white-space:nowrap}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--s3);border:1px solid var(--border);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:500;white-space:nowrap;z-index:900;opacity:0;transition:all .3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-ico{font-size:36px;margin-bottom:12px}
.empty-txt{font-size:14px}

/* ‚îÄ‚îÄ‚îÄ FILTER TABS ‚îÄ‚îÄ‚îÄ */
.filter-tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none}
.filter-tabs::-webkit-scrollbar{display:none}
.ftab{background:var(--s2);border:1px solid var(--border);border-radius:100px;padding:6px 14px;font-size:12px;font-family:var(--font-head);font-weight:600;cursor:pointer;color:var(--sub);white-space:nowrap;transition:all .15s}
.ftab.active{background:var(--accent);color:#111;border-color:var(--accent)}

/* ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ */
.divline{height:1px;background:var(--border);margin:16px 0}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.info-row:last-child{border:none}
.info-key{font-size:12px;color:var(--sub)}
.info-val{font-family:var(--font-head);font-weight:600;font-size:13px}
.pill-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.pill{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:12px;color:var(--sub);font-family:var(--font-head);font-weight:600}
.pill.active{background:var(--accent-dim);border-color:var(--accent-border);color:var(--accent)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-login" class="page active">
  <div class="login-wrap">
    <div class="logo-mark">
      <div class="logo-sq">E</div>
      <div class="logo-text">Ethos<span>Admin</span></div>
    </div>
    <h1 class="login-heading">Conference<br/>Command<br/>Center</h1>
    <p class="login-sub">Sign in with your Google account. Your access level is determined by your email.</p>
    <button class="btn-google" onclick="loginGoogle()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <div class="divider"><span>Dev / Test Login</span></div>
    <p class="dev-section-label">Tap a role to simulate login</p>
    <div class="dev-pills">
      <div class="dev-pill" onclick="devLogin('super')">üëë Super Admin</div>
      <div class="dev-pill" onclick="devLogin('tech')">üîß Tech Team</div>
      <div class="dev-pill" onclick="devLogin('pitch')">üöÄ Pitch Co.</div>
      <div class="dev-pill" onclick="devLogin('speaker')">üé§ Speaker</div>
      <div class="dev-pill" onclick="devLogin('attendee')">üë§ Attendee</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-dash" class="page">
  <div class="topbar">
    <div class="topbar-title" id="dash-title">Admin Dashboard</div>
    <div class="topbar-actions">
      <span class="role-chip" id="dash-role-chip">‚Äî</span>
      <div class="avatar" id="dash-avatar" onclick="showProfile()">?</div>
    </div>
  </div>
  <div class="content">
    <div style="margin-bottom:20px">
      <div style="font-size:13px;color:var(--sub)">Good to see you,</div>
      <div style="font-family:var(--font-head);font-weight:800;font-size:22px;margin-top:2px" id="dash-greeting">Admin</div>
    </div>

    <!-- Stats (tech+super only) -->
    <div id="dash-stats" style="display:none">
      <div class="sec">Live Overview</div>
      <div class="stat-grid">
        <div class="stat hi"><div class="stat-n" id="stat-users">‚Äî</div><div class="stat-l"><span class="live-dot"></span>Attendees</div></div>
        <div class="stat"><div class="stat-n" id="stat-msgs">‚Äî</div><div class="stat-l">Messages</div></div>
        <div class="stat"><div class="stat-n" id="stat-votes">‚Äî</div><div class="stat-l">Votes Cast</div></div>
        <div class="stat"><div class="stat-n" id="stat-stamps">‚Äî</div><div class="stat-l">Booth Stamps</div></div>
      </div>
    </div>

    <!-- Unread alert -->
    <div id="dash-unread-alert" style="display:none;background:rgba(252,189,157,.08);border:1px solid var(--accent-border);border-radius:12px;padding:12px 14px;margin-bottom:16px;cursor:pointer" onclick="goPage('pg-inbox')">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:18px">üí¨</span>
        <div>
          <div style="font-family:var(--font-head);font-weight:700;font-size:14px;color:var(--accent)" id="unread-count-text">3 unread messages</div>
          <div style="font-size:11px;color:var(--sub)">Tap to open inbox ‚Üí</div>
        </div>
      </div>
    </div>

    <!-- Nav tiles -->
    <div class="sec">Sections</div>
    <div class="tiles" id="dash-tiles"><!-- populated by JS --></div>
  </div>
  <div class="bottom-nav" id="dash-nav"><!-- populated by JS --></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INBOX PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-inbox" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">Messages</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="openBroadcastModal()" id="broadcast-btn" style="display:none">üì£ Broadcast</button>
    </div>
  </div>
  <div class="content">
    <div class="filter-tabs">
      <div class="ftab active" onclick="filterMsgs('all',this)">All</div>
      <div class="ftab" onclick="filterMsgs('unread',this)">Unread</div>
      <div class="ftab" onclick="filterMsgs('unreplied',this)">Needs Reply</div>
      <div class="ftab" onclick="filterMsgs('replied',this)">Replied</div>
    </div>
    <div class="msg-list" id="msg-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THREAD PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-thread" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-inbox')">‚Üê</button>
    <div class="topbar-title" id="thread-title">Thread</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="deleteThread()" style="background:rgba(240,112,112,.1);border-color:rgba(240,112,112,.3);color:var(--red)">üóë</button>
    </div>
  </div>
  <div class="content" style="padding:0 0 80px" id="thread-content"></div>
  <div class="reply-bar" id="reply-bar">
    <textarea class="reply-input" id="reply-input" placeholder="Reply to attendee‚Ä¶" rows="1" oninput="autoResize(this)"></textarea>
    <button class="send-btn" onclick="sendReply()">
      <svg viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2.5" width="18" height="18"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VOTES PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-votes" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">Pitch Votes</div>
  </div>
  <div class="content">
    <div class="filter-tabs">
      <div class="ftab active" onclick="sortVotes('avg',this)">Top Rated</div>
      <div class="ftab" onclick="sortVotes('votes',this)">Most Voted</div>
      <div class="ftab" onclick="sortVotes('sustainability',this)">Sustainability</div>
      <div class="ftab" onclick="sortVotes('impact',this)">Impact</div>
    </div>
    <div id="votes-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MY TILE PAGE (Entity Admins) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-mytile" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">My Tile</div>
    <div class="topbar-actions">
      <span id="tile-live-chip" style="font-size:11px;padding:3px 8px;border-radius:6px;font-family:var(--font-head);font-weight:700">‚óè&nbsp;Live</span>
    </div>
  </div>
  <div class="content">
    <div class="sec">Preview</div>
    <div class="tile-preview" id="tile-preview">
      <div class="tile-preview-logo" id="preview-logo">üöÄ</div>
      <div class="tile-preview-body">
        <div class="tile-preview-name" id="preview-name">Your Company</div>
        <div class="tile-preview-tag" id="preview-tag">Tagline shows here</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap" id="preview-contact"></div>
      </div>
    </div>
    <div class="sec">Edit Your Tile</div>
    <div class="form-group"><label class="form-label">Company / Name</label><input class="form-input" id="tile-name" placeholder="e.g. EcoWave Technologies" oninput="livePreview()"/></div>
    <div class="form-group"><label class="form-label">Tagline (one line)</label><input class="form-input" id="tile-tagline" placeholder="Making oceans cleaner" oninput="livePreview()"/></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="tile-desc" placeholder="Tell attendees about your company, research, or talk‚Ä¶" rows="4"></textarea></div>
    <div class="form-group"><label class="form-label">Logo URL</label><input class="form-input" id="tile-logo" placeholder="https://..." oninput="livePreview()"/></div>
    <div class="form-group"><label class="form-label">Contact Email</label><input class="form-input" id="tile-email" placeholder="hello@company.com" type="email" oninput="livePreview()"/></div>
    <div class="form-group"><label class="form-label">Website</label><input class="form-input" id="tile-website" placeholder="https://yoursite.com"/></div>
    <div class="form-group"><label class="form-label">Resume / Portfolio Link (optional)</label><input class="form-input" id="tile-resume" placeholder="https://drive.google.com/..."/></div>
    <button class="btn btn-accent" onclick="saveTile()" style="margin-bottom:8px">Save Changes</button>
    <button class="btn btn-ghost" onclick="toggleTileVisible()">
      <span id="tile-vis-btn-text">Pause Tile Visibility</span>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USERS PAGE (Super only) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-users" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">User Management</div>
  </div>
  <div class="content">
    <input class="form-input" id="user-search" placeholder="üîç  Search by name or email‚Ä¶" oninput="renderUsers()" style="margin-bottom:14px"/>
    <div class="sec">All Users (<span id="user-count">0</span>)</div>
    <div id="users-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODERATION PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-mod" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">Moderation Queue</div>
  </div>
  <div class="content">
    <div id="mod-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ATTENDANCE PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pg-attendance" class="page">
  <div class="topbar">
    <button class="topbar-back" onclick="goPage('pg-dash')">‚Üê</button>
    <div class="topbar-title">Attendance</div>
  </div>
  <div class="content">
    <div class="sec">Booth Passport Progress</div>
    <div id="attendance-list"></div>
    <div class="divline"></div>
    <div class="sec">Raffle Queue (Business Cards Earned)</div>
    <div id="raffle-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-broadcast" onclick="closeModal('modal-broadcast')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">üì£ Broadcast Message</div>
    <div class="modal-sub">This will appear as an announcement for ALL attendees.</div>
    <div class="form-group"><label class="form-label">Message</label><textarea class="form-input" id="broadcast-msg" placeholder="Hey everyone! Session in Auditorium A starts in 10 minutes‚Ä¶" rows="4"></textarea></div>
    <button class="btn btn-accent" onclick="sendBroadcast()">Send to Everyone</button>
  </div>
</div>

<div class="modal-overlay" id="modal-profile" onclick="closeModal('modal-profile')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="profile-name">Profile</div>
    <div class="modal-sub" id="profile-email">email</div>
    <div id="profile-body"></div>
    <button class="btn btn-danger btn-sm" onclick="logout()" style="margin-top:12px;width:100%">Sign Out</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATABASE ADAPTER (localStorage ‚Äî swap for Firebase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  KEY_USERS: 'conf_users',
  KEY_MESSAGES: 'conf_messages',
  KEY_VOTES: 'conf_votes',
  KEY_STAMPS: 'conf_stamps',
  KEY_ENTITIES: 'conf_entities',
  KEY_ROLES: 'conf_role_map',
  KEY_MOD: 'conf_modqueue',
  KEY_SESSION: 'conf_session',

  get(key) {
    try { return JSON.parse(localStorage.getItem(key)) || null; } catch { return null; }
  },
  set(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
  },
  getList(key) { return this.get(key) || []; },
  addToList(key, item) {
    const list = this.getList(key);
    list.push(item);
    this.set(key, list);
    return item;
  },
  updateInList(key, id, patch) {
    const list = this.getList(key);
    const idx = list.findIndex(x => x.id === id);
    if (idx === -1) return false;
    list[idx] = { ...list[idx], ...patch };
    this.set(key, list);
    return true;
  },
  removeFromList(key, id) {
    const list = this.getList(key).filter(x => x.id !== id);
    this.set(key, list);
  },

  // Role map: { email: role }
  getRoleMap() { return this.get(this.KEY_ROLES) || {}; },
  setRole(email, role) {
    const map = this.getRoleMap();
    map[email] = role;
    this.set(this.KEY_ROLES, map);
  },
  getRole(email) {
    const map = this.getRoleMap();
    return map[email] || 'attendee';
  },

  // Session
  getSession() { return this.get(this.KEY_SESSION); },
  setSession(user) { this.set(this.KEY_SESSION, user); },
  clearSession() { localStorage.removeItem(this.KEY_SESSION); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEED DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seedData() {
  // Entities
  if (!DB.get(DB.KEY_ENTITIES)) {
    DB.set(DB.KEY_ENTITIES, [
      { id: 'e1', type: 'pitch', name: 'EcoWave Technologies', tagline: 'Turning ocean plastic into energy', description: 'We convert ocean-bound plastic waste into biofuel using a proprietary microbe-based process.', logoUrl: '', contactEmail: 'hello@ecowave.io', website: 'https://ecowave.io', managedBy: ['pitch@test.com'], boothQrCode: 'BOOTH-e1', active: true },
      { id: 'e2', type: 'pitch', name: 'SolarHive', tagline: 'Distributed solar micro-grids', description: 'Modular solar panels for off-grid communities in developing nations.', logoUrl: '', contactEmail: 'info@solarhive.co', website: 'https://solarhive.co', managedBy: [], boothQrCode: 'BOOTH-e2', active: true },
      { id: 'e3', type: 'pitch', name: 'AirRoots', tagline: 'Vertical farms in shipping containers', description: 'Bringing food production close to urban centers using 95% less water.', logoUrl: '', contactEmail: 'grow@airroots.com', website: 'https://airroots.com', managedBy: [], boothQrCode: 'BOOTH-e3', active: true },
      { id: 'e4', type: 'speaker', name: 'Dr. Maya Chen', tagline: 'Climate Systems Researcher, MIT', description: 'Keynote on tipping points in climate systems and actionable pathways forward.', logoUrl: '', contactEmail: 'maya@mit.edu', website: '', managedBy: ['speaker@test.com'], boothQrCode: null, active: true },
      { id: 'e5', type: 'pitch', name: 'ReCarbon', tagline: 'Direct air capture at scale', description: 'Low-cost DAC technology using waste heat from industrial processes.', logoUrl: '', contactEmail: 'carbon@recarbon.io', website: 'https://recarbon.io', managedBy: [], boothQrCode: 'BOOTH-e5', active: true },
    ]);
  }

  // Messages
  if (!DB.get(DB.KEY_MESSAGES)) {
    DB.set(DB.KEY_MESSAGES, [
      { id: 'm1', fromUid: 'u_att1', fromEmail: 'alex@example.com', fromName: 'Alex Rivera', toUid: 'admin', body: "Hey! What time does the pitch room open tomorrow? I can't find it on the schedule.", read: false, adminReply: null, repliedAt: null, createdAt: Date.now() - 3600000 },
      { id: 'm2', fromUid: 'u_att2', fromEmail: 'priya@example.com', fromName: 'Priya Sharma', toUid: 'admin', body: "The WiFi password isn't working in the poster hall. Can someone help?", read: false, adminReply: null, repliedAt: null, createdAt: Date.now() - 7200000 },
      { id: 'm3', fromUid: 'u_att3', fromEmail: 'jakub@example.com', fromName: 'Jakub Nowak', toUid: 'admin', body: "Is it possible to get a printed version of the schedule? The app isn't loading for me.", read: true, adminReply: "Hi Jakub! We're printing extras at the info desk ‚Äî grab one there. Also try clearing your browser cache to fix the app!", repliedAt: Date.now() - 1800000, createdAt: Date.now() - 10800000 },
      { id: 'm4', fromUid: 'u_att4', fromEmail: 'sonia@example.com', fromName: 'Sonia Okafor', toUid: 'admin', body: "Loved the keynote!! Dr. Chen was incredible. Any chance the slides get shared?", read: false, adminReply: null, repliedAt: null, createdAt: Date.now() - 900000 },
      { id: 'bc1', fromUid: 'system', fromEmail: 'system', fromName: 'System', toUid: 'broadcast', body: "Welcome to Ethos 2025! üå± Check the Schedule tab for today's sessions. The pitch room opens at 10am.", read: true, adminReply: null, repliedAt: null, createdAt: Date.now() - 86400000 },
    ]);
  }

  // Votes
  if (!DB.get(DB.KEY_VOTES)) {
    const pitches = ['e1','e2','e3','e5'];
    const votes = [];
    const users = ['u1','u2','u3','u4','u5','u6','u7','u8'];
    pitches.forEach(pid => {
      users.forEach(uid => {
        if (Math.random() > 0.3) {
          votes.push({
            id: `v_${pid}_${uid}`,
            pitchId: pid,
            voterUid: uid,
            sustainability: Math.floor(Math.random()*3)+7,
            impact: Math.floor(Math.random()*4)+6,
            feasibility: Math.floor(Math.random()*4)+5,
            overall: Math.floor(Math.random()*3)+7,
            createdAt: Date.now() - Math.random()*86400000
          });
        }
      });
    });
    DB.set(DB.KEY_VOTES, votes);
  }

  // Stamps
  if (!DB.get(DB.KEY_STAMPS)) {
    DB.set(DB.KEY_STAMPS, [
      { id: 's1', userId: 'u1', boothId: 'e1', room: 'poster_room', scannedAt: Date.now()-1000 },
      { id: 's2', userId: 'u1', boothId: 'e2', room: 'poster_room', scannedAt: Date.now()-2000 },
      { id: 's3', userId: 'u2', boothId: 'e1', room: 'poster_room', scannedAt: Date.now()-3000 },
      { id: 's4', userId: 'u3', boothId: 'e3', room: 'conference_room', scannedAt: Date.now()-4000 },
    ]);
  }

  // Users
  if (!DB.get(DB.KEY_USERS)) {
    DB.set(DB.KEY_USERS, [
      { uid: 'u_super', email: 'super@ethos.com', name: 'Jordan Lee', photoURL: '', role: 'super', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
      { uid: 'u_tech', email: 'tech@ethos.com', name: 'Sam Patel', photoURL: '', role: 'tech', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
      { uid: 'u_pitch', email: 'pitch@test.com', name: 'Taylor EcoWave', photoURL: '', role: 'entity', entityType: 'pitch', entityId: 'e1', resumeLink: '', businessCard: {} },
      { uid: 'u_spkr', email: 'speaker@test.com', name: 'Dr. Maya Chen', photoURL: '', role: 'entity', entityType: 'speaker', entityId: 'e4', resumeLink: '', businessCard: {} },
      { uid: 'u_att1', email: 'alex@example.com', name: 'Alex Rivera', photoURL: '', role: 'attendee', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
      { uid: 'u_att2', email: 'priya@example.com', name: 'Priya Sharma', photoURL: '', role: 'attendee', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
      { uid: 'u_att3', email: 'jakub@example.com', name: 'Jakub Nowak', photoURL: '', role: 'attendee', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
      { uid: 'u_att4', email: 'sonia@example.com', name: 'Sonia Okafor', photoURL: '', role: 'attendee', entityType: null, entityId: null, resumeLink: '', businessCard: {} },
    ]);
  }

  // Role map
  if (!DB.get(DB.KEY_ROLES)) {
    DB.set(DB.KEY_ROLES, {
      'super@ethos.com': 'super',
      'tech@ethos.com': 'tech',
      'pitch@test.com': 'entity_pitch',
      'speaker@test.com': 'entity_speaker',
    });
  }

  // Mod queue
  if (!DB.get(DB.KEY_MOD)) {
    DB.set(DB.KEY_MOD, [
      { id: 'mod1', type: 'message', fromName: 'Anonymous', content: 'This conference is dumb and the pitches are terrible lmao', reason: 'Flagged: negative/spam', status: 'pending', createdAt: Date.now()-600000 },
    ]);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let currentMsgFilter = 'all';
let currentVoteSort = 'avg';
let activeMsgId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEV_USERS = {
  super:    { uid: 'u_super',  email: 'super@ethos.com',   name: 'Jordan Lee',    role: 'super',   entityType: null,    entityId: null },
  tech:     { uid: 'u_tech',   email: 'tech@ethos.com',    name: 'Sam Patel',     role: 'tech',    entityType: null,    entityId: null },
  pitch:    { uid: 'u_pitch',  email: 'pitch@test.com',    name: 'Taylor EcoWave',role: 'entity',  entityType: 'pitch', entityId: 'e1' },
  speaker:  { uid: 'u_spkr',  email: 'speaker@test.com',  name: 'Dr. Maya Chen', role: 'entity',  entityType: 'speaker',entityId: 'e4' },
  attendee: { uid: 'u_att99', email: 'demo@example.com',  name: 'Demo Attendee', role: 'attendee',entityType: null,    entityId: null },
};

function loginGoogle() {
  showToast('Google OAuth not configured ‚Äî use dev login below');
}

function devLogin(roleKey) {
  const user = DEV_USERS[roleKey];
  currentUser = user;
  DB.setSession(user);
  afterLogin();
}

function afterLogin() {
  seedData();
  // Redirect attendees back to main app
  if (currentUser.role === 'attendee') {
    showToast('Attendees use the main app ‚Äî redirecting...');
    setTimeout(() => { window.location.href = '/Conference/'; }, 1500);
    return;
  }
  buildDash();
  goPage('pg-dash');
}

function logout() {
  DB.clearSession();
  currentUser = null;
  closeModal('modal-profile');
  goPage('pg-login');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD BUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLE_LABELS = { super: 'Super Admin', tech: 'Tech Team', entity: 'Tile Admin' };
const ROLE_CHIPS  = { super: 'chip-super', tech: 'chip-tech', entity: 'chip-entity' };

function buildDash() {
  const u = currentUser;
  const roleLabel = ROLE_LABELS[u.role] || u.role;
  const chipClass = ROLE_CHIPS[u.role] || 'chip-entity';

  document.getElementById('dash-title').textContent = roleLabel + ' Panel';
  document.getElementById('dash-greeting').textContent = u.name;
  const chip = document.getElementById('dash-role-chip');
  chip.textContent = roleLabel;
  chip.className = 'role-chip ' + chipClass;

  const av = document.getElementById('dash-avatar');
  av.textContent = u.name.charAt(0).toUpperCase();

  const msgs = DB.getList(DB.KEY_MESSAGES);
  const unread = msgs.filter(m => !m.read && m.toUid !== 'broadcast').length;

  // Stats (tech + super)
  const statsEl = document.getElementById('dash-stats');
  if (u.role === 'tech' || u.role === 'super') {
    statsEl.style.display = 'block';
    const users = DB.getList(DB.KEY_USERS);
    const votes = DB.getList(DB.KEY_VOTES);
    const stamps = DB.getList(DB.KEY_STAMPS);
    document.getElementById('stat-users').textContent = users.filter(x=>x.role==='attendee').length;
    document.getElementById('stat-msgs').textContent = msgs.filter(m=>m.toUid!=='broadcast').length;
    document.getElementById('stat-votes').textContent = votes.length;
    document.getElementById('stat-stamps').textContent = stamps.length;
  }

  // Unread alert
  const alertEl = document.getElementById('dash-unread-alert');
  if (unread > 0 && (u.role === 'tech' || u.role === 'super')) {
    alertEl.style.display = 'block';
    document.getElementById('unread-count-text').textContent = unread + ' unread message' + (unread>1?'s':'');
  }

  // Tiles per role
  const allTiles = [
    { id: 'inbox',      label: 'Messages',       desc: () => { const u=DB.getList(DB.KEY_MESSAGES).filter(m=>!m.read&&m.toUid!=='broadcast').length; return u>0?u+' unread':'All clear'; }, ico: 'üí¨', icoClass: 'ico-o', roles: ['tech','super'], page: 'pg-inbox', badge: () => { const u=DB.getList(DB.KEY_MESSAGES).filter(m=>!m.read&&m.toUid!=='broadcast').length; return u>0?u:null; } },
    { id: 'votes',      label: 'Pitch Results',  desc: () => DB.getList(DB.KEY_VOTES).length+' votes cast',     ico: 'üìä', icoClass: 'ico-b', roles: ['tech','super'], page: 'pg-votes' },
    { id: 'users',      label: 'Users & Roles',  desc: () => DB.getList(DB.KEY_USERS).length+' registered',     ico: 'üë•', icoClass: 'ico-p', roles: ['super'],         page: 'pg-users' },
    { id: 'mod',        label: 'Moderation',     desc: () => { const p=DB.getList(DB.KEY_MOD).filter(x=>x.status==='pending').length; return p>0?p+' pending review':'Queue clear'; }, ico: 'üõ°Ô∏è', icoClass: 'ico-r', roles: ['tech','super'], page: 'pg-mod' },
    { id: 'attendance', label: 'Booth Passport', desc: () => DB.getList(DB.KEY_STAMPS).length+' stamps recorded', ico: 'üó∫Ô∏è', icoClass: 'ico-g', roles: ['tech','super'], page: 'pg-attendance' },
    { id: 'mytile',     label: 'My Tile',        desc: () => 'Edit your public profile',                         ico: '‚úèÔ∏è', icoClass: 'ico-y', roles: ['entity'],        page: 'pg-mytile' },
  ];

  const container = document.getElementById('dash-tiles');
  container.innerHTML = '';
  allTiles.forEach(t => {
    if (!t.roles.includes(u.role)) return;
    const badge = t.badge ? t.badge() : null;
    container.innerHTML += `
      <div class="tile" onclick="navTile('${t.page}','${t.id}')">
        <div class="tile-ico ${t.icoClass}">${t.ico}</div>
        <div class="tile-body">
          <div class="tile-name">${t.label}</div>
          <div class="tile-desc">${t.desc()}</div>
        </div>
        <div class="tile-right">
          ${badge ? `<div class="badge">${badge}</div>` : ''}
          <div class="chevron">‚Ä∫</div>
        </div>
      </div>`;
  });

  buildBottomNav();
}

function navTile(page, id) {
  if (page === 'pg-inbox') renderInbox();
  if (page === 'pg-votes') renderVotes();
  if (page === 'pg-users') renderUsers();
  if (page === 'pg-mod') renderMod();
  if (page === 'pg-attendance') renderAttendance();
  if (page === 'pg-mytile') loadMyTile();
  goPage(page);
}

function buildBottomNav() {
  const u = currentUser;
  const nav = document.getElementById('dash-nav');
  const unread = DB.getList(DB.KEY_MESSAGES).filter(m=>!m.read&&m.toUid!=='broadcast').length;

  const items = [];
  items.push({ icon: homeSVG, label: 'Home', page: 'pg-dash', always: true });
  if (u.role==='tech'||u.role==='super') {
    items.push({ icon: msgSVG, label: 'Messages', page: 'pg-inbox', pip: unread>0 });
    items.push({ icon: chartSVG, label: 'Votes', page: 'pg-votes' });
  }
  if (u.role==='super') items.push({ icon: usersSVG, label: 'Users', page: 'pg-users' });
  if (u.role==='entity') items.push({ icon: editSVG, label: 'My Tile', page: 'pg-mytile' });

  nav.innerHTML = items.map((item, i) => `
    <button class="nav-btn ${i===0?'active':''}" onclick="navTo('${item.page}','${item.id||''}',this)">
      <div class="nav-ico-wrap">
        ${item.icon}
        ${item.pip ? '<div class="nav-pip"></div>' : ''}
      </div>
      <span>${item.label}</span>
    </button>`).join('');
}

function navTo(page, id, btn) {
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  navTile(page, id);
  goPage(page);
}

// SVG icons
const homeSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`;
const msgSVG  = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>`;
const chartSVG= `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`;
const usersSVG= `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>`;
const editSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInbox() {
  if (currentUser.role==='tech'||currentUser.role==='super') {
    document.getElementById('broadcast-btn').style.display = 'inline-flex';
  }
  const msgs = DB.getList(DB.KEY_MESSAGES).filter(m => m.toUid !== 'broadcast');
  let filtered = msgs;
  if (currentMsgFilter==='unread') filtered = msgs.filter(m=>!m.read);
  if (currentMsgFilter==='unreplied') filtered = msgs.filter(m=>!m.adminReply);
  if (currentMsgFilter==='replied') filtered = msgs.filter(m=>m.adminReply);

  filtered.sort((a,b) => b.createdAt - a.createdAt);

  const container = document.getElementById('msg-list');
  if (!filtered.length) {
    container.innerHTML = `<div class="empty"><div class="empty-ico">‚úÖ</div><div class="empty-txt">Nothing here!</div></div>`;
    return;
  }

  container.innerHTML = filtered.map(m => `
    <div class="msg-card ${m.read?'':'unread'}" onclick="openThread('${m.id}')">
      <div class="msg-header">
        <div class="msg-from">${esc(m.fromName)}</div>
        <div class="msg-time">${timeAgo(m.createdAt)}</div>
      </div>
      <div class="msg-preview">${esc(m.body)}</div>
      <div class="msg-tags">
        ${!m.read?'<span class="tag tag-new">New</span>':'<span class="tag tag-read">Read</span>'}
        ${m.adminReply?'<span class="tag tag-replied">Replied</span>':''}
        <span class="tag" style="background:var(--s3);color:var(--muted)">${esc(m.fromEmail)}</span>
      </div>
    </div>`).join('');
}

function filterMsgs(f, btn) {
  currentMsgFilter = f;
  document.querySelectorAll('.filter-tabs .ftab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderInbox();
}

function openThread(id) {
  activeMsgId = id;
  const msgs = DB.getList(DB.KEY_MESSAGES);
  const msg = msgs.find(m => m.id === id);
  if (!msg) return;

  // Mark read
  DB.updateInList(DB.KEY_MESSAGES, id, { read: true });

  document.getElementById('thread-title').textContent = msg.fromName;

  const content = document.getElementById('thread-content');
  const bubbles = [
    `<div class="bubble-wrap from-user">
      <div class="bubble-name">${esc(msg.fromName)}</div>
      <div class="bubble">${esc(msg.body)}</div>
      <div class="bubble-time">${timeAgo(msg.createdAt)}</div>
    </div>`
  ];
  if (msg.adminReply) {
    bubbles.push(`<div class="bubble-wrap from-admin">
      <div class="bubble-name">You (Admin)</div>
      <div class="bubble">${esc(msg.adminReply)}</div>
      <div class="bubble-time">${timeAgo(msg.repliedAt)}</div>
    </div>`);
  }
  content.innerHTML = `<div class="thread-msgs">${bubbles.join('')}</div>`;

  // Show/hide reply bar for entity admins (they can only view)
  const replyBar = document.getElementById('reply-bar');
  if (currentUser.role === 'entity') {
    replyBar.style.display = 'none';
  } else {
    replyBar.style.display = 'flex';
  }

  goPage('pg-thread');
}

function sendReply() {
  const input = document.getElementById('reply-input');
  const text = input.value.trim();
  if (!text || !activeMsgId) return;

  DB.updateInList(DB.KEY_MESSAGES, activeMsgId, {
    adminReply: text,
    repliedAt: Date.now(),
    read: true
  });

  input.value = '';
  openThread(activeMsgId);
  showToast('Reply sent ‚úì');
}

function deleteThread() {
  if (!activeMsgId) return;
  DB.removeFromList(DB.KEY_MESSAGES, activeMsgId);
  goPage('pg-inbox');
  renderInbox();
  showToast('Message deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderVotes() {
  const entities = DB.getList(DB.KEY_ENTITIES).filter(e=>e.type==='pitch');
  const votes = DB.getList(DB.KEY_VOTES);

  const summaries = entities.map(e => {
    const ev = votes.filter(v=>v.pitchId===e.id);
    if (!ev.length) return { entity: e, count: 0, sustainability: 0, impact: 0, feasibility: 0, overall: 0, avg: 0 };
    const avg = k => (ev.reduce((s,v)=>s+v[k],0)/ev.length);
    const s = avg('sustainability'), im = avg('impact'), f = avg('feasibility'), o = avg('overall');
    return { entity: e, count: ev.length, sustainability: s, impact: im, feasibility: f, overall: o, avg: (s+im+f+o)/4 };
  });

  summaries.sort((a,b) => b[currentVoteSort==='avg'?'avg':currentVoteSort] - a[currentVoteSort==='avg'?'avg':currentVoteSort]);

  document.getElementById('votes-list').innerHTML = summaries.map(s => `
    <div class="vote-card">
      <div class="vote-company">
        <span>${esc(s.entity.name)}</span>
        <span class="vote-total">${s.count} votes ¬∑ avg ${s.avg.toFixed(1)}</span>
      </div>
      ${[['sustainability','üå± Sustainable'],['impact','üí• Impact'],['feasibility','‚öôÔ∏è Feasibility'],['overall','‚≠ê Overall']].map(([k,lbl]) => `
        <div class="score-row">
          <div class="score-label">${lbl}</div>
          <div class="score-bar-wrap"><div class="score-bar" style="width:${s[k]*10}%"></div></div>
          <div class="score-num">${s[k].toFixed(1)}</div>
        </div>`).join('')}
    </div>`).join('');
}

function sortVotes(by, btn) {
  currentVoteSort = by;
  document.querySelectorAll('#pg-votes .ftab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderVotes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MY TILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadMyTile() {
  const u = currentUser;
  const entities = DB.getList(DB.KEY_ENTITIES);
  const entity = entities.find(e => e.id === u.entityId) || entities[0];
  if (!entity) return;

  document.getElementById('tile-name').value = entity.name || '';
  document.getElementById('tile-tagline').value = entity.tagline || '';
  document.getElementById('tile-desc').value = entity.description || '';
  document.getElementById('tile-logo').value = entity.logoUrl || '';
  document.getElementById('tile-email').value = entity.contactEmail || '';
  document.getElementById('tile-website').value = entity.website || '';
  document.getElementById('tile-resume').value = entity.resumeLink || '';

  const chip = document.getElementById('tile-live-chip');
  if (entity.active) {
    chip.style.background = 'rgba(82,214,138,.15)';
    chip.style.color = 'var(--green)';
    chip.style.border = '1px solid rgba(82,214,138,.3)';
    chip.style.borderRadius = '8px';
    chip.style.padding = '3px 10px';
    chip.style.fontSize = '11px';
    chip.style.fontFamily = 'var(--font-head)';
    chip.style.fontWeight = '700';
    chip.textContent = '‚óè Live';
    document.getElementById('tile-vis-btn-text').textContent = 'Pause Tile Visibility';
  } else {
    chip.style.background = 'rgba(240,112,112,.15)';
    chip.style.color = 'var(--red)';
    chip.style.border = '1px solid rgba(240,112,112,.3)';
    chip.textContent = '‚óè Hidden';
    document.getElementById('tile-vis-btn-text').textContent = 'Make Tile Visible';
  }

  livePreview();
}

function livePreview() {
  const name = document.getElementById('tile-name').value || 'Your Company';
  const tag = document.getElementById('tile-tagline').value || 'Tagline shows here';
  const logo = document.getElementById('tile-logo').value;
  const email = document.getElementById('tile-email').value;

  document.getElementById('preview-name').textContent = name;
  document.getElementById('preview-tag').textContent = tag;

  const logoEl = document.getElementById('preview-logo');
  if (logo) {
    logoEl.innerHTML = `<img src="${esc(logo)}" onerror="this.parentElement.innerHTML='üöÄ'" alt="logo"/>`;
  } else {
    const types = { pitch: 'üöÄ', speaker: 'üé§', partner: 'ü§ù' };
    logoEl.textContent = types[currentUser.entityType] || 'üè¢';
  }

  const contact = document.getElementById('preview-contact');
  contact.innerHTML = email ? `<span style="font-size:11px;color:var(--sub)">${esc(email)}</span>` : '';
}

function saveTile() {
  const u = currentUser;
  const entities = DB.getList(DB.KEY_ENTITIES);
  const idx = entities.findIndex(e => e.id === u.entityId);
  if (idx === -1) return;

  entities[idx] = {
    ...entities[idx],
    name: document.getElementById('tile-name').value,
    tagline: document.getElementById('tile-tagline').value,
    description: document.getElementById('tile-desc').value,
    logoUrl: document.getElementById('tile-logo').value,
    contactEmail: document.getElementById('tile-email').value,
    website: document.getElementById('tile-website').value,
    resumeLink: document.getElementById('tile-resume').value,
    updatedAt: Date.now()
  };

  DB.set(DB.KEY_ENTITIES, entities);
  showToast('Tile saved ‚úì');
}

function toggleTileVisible() {
  const u = currentUser;
  const entities = DB.getList(DB.KEY_ENTITIES);
  const idx = entities.findIndex(e => e.id === u.entityId);
  if (idx === -1) return;
  entities[idx].active = !entities[idx].active;
  DB.set(DB.KEY_ENTITIES, entities);
  loadMyTile();
  showToast(entities[idx].active ? 'Tile is now visible ‚úì' : 'Tile hidden from attendees');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USERS (super only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsers() {
  const users = DB.getList(DB.KEY_USERS);
  const search = (document.getElementById('user-search')?.value||'').toLowerCase();
  const filtered = users.filter(u => u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
  document.getElementById('user-count').textContent = filtered.length;

  const ROLE_OPTIONS = ['attendee','entity','tech','super'];
  document.getElementById('users-list').innerHTML = filtered.map(u => `
    <div class="user-row">
      <div class="user-ava" style="background:${strColor(u.name)}">${u.name.charAt(0).toUpperCase()}</div>
      <div class="user-info">
        <div class="user-name">${esc(u.name)}</div>
        <div class="user-email">${esc(u.email)}</div>
      </div>
      <select class="user-role-sel" onchange="changeRole('${esc(u.uid)}','${esc(u.email)}',this.value)">
        ${ROLE_OPTIONS.map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
      </select>
    </div>`).join('');
}

function changeRole(uid, email, newRole) {
  const users = DB.getList(DB.KEY_USERS);
  const idx = users.findIndex(u=>u.uid===uid);
  if (idx !== -1) { users[idx].role = newRole; DB.set(DB.KEY_USERS, users); }
  DB.setRole(email, newRole);
  showToast('Role updated ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMod() {
  const queue = DB.getList(DB.KEY_MOD).filter(m=>m.status==='pending');
  const container = document.getElementById('mod-list');
  if (!queue.length) {
    container.innerHTML = `<div class="empty"><div class="empty-ico">‚úÖ</div><div class="empty-txt">Queue is clear!</div></div>`;
    return;
  }
  container.innerHTML = queue.map(m => `
    <div class="mod-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-family:var(--font-head);font-weight:700;font-size:14px">${esc(m.fromName)}</div>
        <div style="font-size:11px;color:var(--red)">${esc(m.reason)}</div>
      </div>
      <div class="mod-content">"${esc(m.content)}"</div>
      <div style="font-size:11px;color:var(--muted)">${timeAgo(m.createdAt)}</div>
      <div class="mod-actions">
        <button class="mod-btn mod-approve" onclick="modAction('${m.id}','approved')">‚úì Approve</button>
        <button class="mod-btn mod-reject" onclick="modAction('${m.id}','rejected')">‚úó Remove</button>
      </div>
    </div>`).join('');
}

function modAction(id, status) {
  DB.updateInList(DB.KEY_MOD, id, { status });
  renderMod();
  showToast(status === 'approved' ? 'Content approved' : 'Content removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ATTENDANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAttendance() {
  const stamps = DB.getList(DB.KEY_STAMPS);
  const entities = DB.getList(DB.KEY_ENTITIES);
  const users = DB.getList(DB.KEY_USERS);
  const votes = DB.getList(DB.KEY_VOTES);

  const posterBooths = entities.filter(e=>e.boothQrCode&&e.active&&e.type!=='speaker');
  const confBooths = posterBooths; // same for demo
  const totalPoster = Math.max(posterBooths.length, 1);

  // Per-user progress
  const userProgress = {};
  stamps.forEach(s => {
    if (!userProgress[s.userId]) userProgress[s.userId] = { poster: new Set(), conference: new Set() };
    if (s.room === 'poster_room') userProgress[s.userId].poster.add(s.boothId);
    if (s.room === 'conference_room') userProgress[s.userId].conference.add(s.boothId);
  });

  const attUsers = users.filter(u=>u.role==='attendee');
  const container = document.getElementById('attendance-list');

  if (!attUsers.length) {
    container.innerHTML = `<div class="empty"><div class="empty-ico">üë•</div><div class="empty-txt">No attendees yet</div></div>`;
  } else {
    container.innerHTML = attUsers.map(u => {
      const p = userProgress[u.uid] || { poster: new Set(), conference: new Set() };
      const posterPct = Math.min(100, Math.round(p.poster.size / totalPoster * 100));
      const confPct = Math.min(100, Math.round(p.conference.size / totalPoster * 100));
      const voted = votes.some(v=>v.voterUid===u.uid);
      const raffleEligible = posterPct===100 && confPct===100 && voted;
      return `<div class="tile" style="margin-bottom:8px;cursor:default">
        <div class="tile-ico ico-g">${u.name.charAt(0)}</div>
        <div class="tile-body">
          <div class="tile-name">${esc(u.name)}</div>
          <div style="margin-top:6px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
              <div style="font-size:10px;color:var(--sub);width:60px">Posters</div>
              <div style="flex:1;background:var(--s3);border-radius:4px;height:5px"><div style="width:${posterPct}%;height:100%;background:var(--accent);border-radius:4px;transition:width .4s"></div></div>
              <div style="font-size:10px;color:var(--sub)">${posterPct}%</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <div style="font-size:10px;color:var(--sub);width:60px">Conf.</div>
              <div style="flex:1;background:var(--s3);border-radius:4px;height:5px"><div style="width:${confPct}%;height:100%;background:var(--blue);border-radius:4px;transition:width .4s"></div></div>
              <div style="font-size:10px;color:var(--sub)">${confPct}%</div>
            </div>
          </div>
        </div>
        <div>${raffleEligible ? '<span class="badge" style="background:var(--green);color:#111">Raffle ‚úì</span>' : voted ? '<span class="badge badge-blue">Voted</span>' : ''}</div>
      </div>`;
    }).join('');
  }

  const raffleList = document.getElementById('raffle-list');
  const raffleUsers = attUsers.filter(u => {
    const p = userProgress[u.uid] || { poster: new Set(), conference: new Set() };
    const voted = votes.some(v=>v.voterUid===u.uid);
    return p.poster.size >= totalPoster && p.conference.size >= totalPoster && voted;
  });

  raffleList.innerHTML = raffleUsers.length
    ? raffleUsers.map(u=>`<div class="tile" style="margin-bottom:6px;cursor:default"><div class="tile-ico ico-g">üéüÔ∏è</div><div class="tile-body"><div class="tile-name">${esc(u.name)}</div><div class="tile-desc">${esc(u.email)}</div></div></div>`).join('')
    : `<div class="empty"><div class="empty-ico">üéüÔ∏è</div><div class="empty-txt">No one has completed the passport yet</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BROADCAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBroadcastModal() {
  openModal('modal-broadcast');
}

function sendBroadcast() {
  const msg = document.getElementById('broadcast-msg').value.trim();
  if (!msg) return;
  DB.addToList(DB.KEY_MESSAGES, {
    id: 'bc' + Date.now(),
    fromUid: currentUser.uid,
    fromEmail: currentUser.email,
    fromName: currentUser.name + ' (Admin)',
    toUid: 'broadcast',
    body: msg,
    read: true,
    adminReply: null,
    repliedAt: null,
    createdAt: Date.now()
  });
  document.getElementById('broadcast-msg').value = '';
  closeModal('modal-broadcast');
  showToast('Broadcast sent to all attendees ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showProfile() {
  const u = currentUser;
  document.getElementById('profile-name').textContent = u.name;
  document.getElementById('profile-email').textContent = u.email;
  const ROLE_MAP = { super: 'Super Admin', tech: 'Tech Team', entity: 'Tile Admin' };
  document.getElementById('profile-body').innerHTML = `
    <div class="info-row"><span class="info-key">Role</span><span class="info-val">${ROLE_MAP[u.role]||u.role}</span></div>
    <div class="info-row"><span class="info-key">Entity Type</span><span class="info-val">${u.entityType||'‚Äî'}</span></div>
    <div class="info-row"><span class="info-key">Entity ID</span><span class="info-val">${u.entityId||'‚Äî'}</span></div>
    <div style="margin-top:12px;font-size:11px;color:var(--muted);text-align:center">Storage: localStorage (dev mode)</div>`;
  openModal('modal-profile');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function timeAgo(ts) {
  const d = Date.now() - ts;
  if (d < 60000) return 'just now';
  if (d < 3600000) return Math.floor(d/60000) + 'm ago';
  if (d < 86400000) return Math.floor(d/3600000) + 'h ago';
  return Math.floor(d/86400000) + 'd ago';
}

function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function strColor(str) {
  let h = 0; for (let c of str||'') h = ((h<<5)-h)+c.charCodeAt(0);
  const hue = Math.abs(h) % 360;
  return `hsl(${hue}, 55%, 38%)`;
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init() {
  seedData();
  const session = DB.getSession();
  if (session && session.role !== 'attendee') {
    currentUser = session;
    buildDash();
    goPage('pg-dash');
  }
})();
</script>
</body>
</html>
